End to end tests
===

Currently, plugins can only be tested when they're installed into a django-simple-deploy test environment.

To manage this, the end to end tests for this project do the following:

- Get a temp dir from pytest.
- Make a shallow clone of django-simple-deploy into the temp dir.
- For each plugin test:
    - Generate the plugin using `generate_plugin()`.
    - Install the plugin to the temp django-simple-deploy env.
    - Run django-simple-deploy's tests, which in turn run the plugin's tests.
    - Uninstall the plugin from the django-simple-deploy env.

CLI args
---

There are three CLI args that can help with e2e testing:

`-s`
---

This is a pytest flag that streams output as the test runs. Since these are long running tests, it's almost always useful to include this flag. Otherwise it can look like the tests are hanging.

`--run-core-tests`
---

This flag runs the full set of django-simple-deploy tests, for every test plugin. This takes a lot longer. The default behavior is to only use django-simple-deploy to run the plugin's tests.

`--setup-plugins-only`
---

When we run this project's e2e tests, we're actually calling pytest within a temp django-simple-deploy env, once for every test plugin. That means the temp dirs such as `pytest-237` get garbage collected even before the test finishes running. That makes it difficult to see what kind of environment is being built.

The `--setup-plugins-only` flag prevents any tests from being run. We just set up the temp dev environment for django-simple-deploy, and then generate the full series of test plugins. You can then drop into the latest temp pytest directory, and poke around the full test environment.

Here's what that looks like:

```sh
$ pytest tests/e2e_tests -s --setup-plugins-only
...
Building e2e test env at: /private/.../pytest-239/e2e_new_plugin_test0
...
    Built django-simple-deploy...
    Built dsd-newfly...
    Built dsd-newplatform...
    Built dsd-my-plugin...
...
```

In just a few seconds, you have a development environment for django-simple-deploy, alongside a set of plugins generated by this project.

You can cd to this folder, and do anything you want with these resources. Here's how to drop into that folder, see the plugins, install one to the django-simple-deploy environment, and run the new platform's integration tests:

```sh
$ cd /private/.../pytest-239/e2e_new_plugin_test0 
e2e_new_plugin_test0$ ls -l
django-simple-deploy
dsd-my-plugin
dsd-newfly
dsd-newplatform
e2e_new_plugin_test0$ cd django-simple-deploy 
django-simple-deploy$ source .venv/bin/activate
(.venv) django-simple-deploy$ uv pip install -e ../dsd-newplatform 
      Built dsd-newplatform
...
(.venv) django-simple-deploy$ pytest -k newplatform
========== test session starts ========================
collected 77 items / 59 deselected / 18 selected
test_newplatform_config.py ..................    [100%]
========== 18 passed, 59 deselected in 3.65s ==========
```

This is really helpful for maintaining the test suite, and for development work.

**Note:** This can get a little flaky, because we're working in a temp environment that pytest will destroy when more resources are created. If you want to keep working with these resources, you can copy the entire `e2e_new_plugin_test0` directory to a more stable location. You'll have to rebuild the `django-simple-deploy/.venv` environment, but you'll have a useful, stable development environment to work with. You'll be able to run any tests you want from that environment.

Testing custom plugin CLI args
---

A plugin can extend the core django-simple-deploy CLI by defining its own custom CLI args. The code for doing this is included in the generated plugin, but code that would actually define a custom CLI arg is commented out.

The e2e test suite for this plugin generator includes `e2e_tests/test_plugin_cli.py`. This test uncomments the relevant code from a generated plugin. It inserts a block of code that uses the custom CLI arg in a `deploy` call, and asserts that the expected custom behavior works successfully. It also tests that `manage.py deploy --help` includes output documenting usage of the custom CLI arg.
